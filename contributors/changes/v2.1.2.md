## 2.1.2 (@@YYYYMMDD@@)

### First-time install of DkML

Before you run the installer: Make sure your Windows username does not contain a space character (e.g. for `C:\Users\Jane Smith`, OCaml will not install properly).

Run the following in a terminal (either Windows PowerShell or Command Prompt):

```powershell
winget install Microsoft.VisualStudio.2022.BuildTools --override "--wait --passive --installPath C:\VS17 --addProductLang En-us --add Microsoft.VisualStudio.Workload.VCTools --add Microsoft.VisualStudio.Component.VC.14.38.17.8.x86.x64 --includeRecommended"
winget install Git.Git
winget install Diskuv.OCaml
```

And then in a **NEW** terminal:

```powershell
dkml init --system
```

### Upgrading from version 2.1.0 or later

In PowerShell or Command Prompt:

```powershell
winget upgrade dkml
```

### Upgrading from versions earlier than 2.1.0

1. Download and run the "Windows/Intel 64-bit Native Uninstaller" from [DkML Releases 2.1.2](https://gitlab.com/dkml/distributions/dkml/-/releases/2.1.2).
2. Open **Add or remove programs** from Windows Search (type Windows key and then start typing "Add or remove programs")
   * Uninstall `Diskuv OCaml` and/or `DkML Native` and/or `DkML Bytecode` if you see them; you can ignore any failures. You can now close "Add or remove programs".
3. Open PowerShell and run the following:

   ```powershell
   if (Test-Path $env:LOCALAPPDATA\Programs\DkMLNative\bin) { del -force -recurse $env:LOCALAPPDATA\Programs\DkMLNative\bin }
   if (Test-Path $env:LOCALAPPDATA\Programs\DkMLNative\usr\bin) { del -force -recurse $env:LOCALAPPDATA\Programs\DkMLNative\usr\bin }
   ```

4. In PowerShell:

   ```powershell
   winget install dkml
   ```

### What do I do after the install is complete?

You SHOULD read the "Install is done! What next?" at <https://diskuv.com/dkmlbook/#install-is-done-what-next> documentation.

If you had any existing local switches, upgrade them by doing `dkml init`, `opam upgrade` and `opam install . --deps-only` in the local switch directories.

For projects using [`setup-dkml` (part of  `dkml-workflows`)](https://github.com/diskuv/dkml-workflows#dkml-workflows)
for their GitHub Actions / GitLab CI:

1. Re-run `dkml init`, `opam upgrade` and `opam install . --deps-only` in your project
2. Follow the THIRD step of <https://github.com/diskuv/dkml-workflows#configure-your-project>

### Major Changes

* Use opam 2.2.0
* Support Windows SDK 11 (10.0.22621.0) and VC 17.9 and 17.10 (14.39/4x) added to allowed list. This makes it easier to coexist with opam 2.2 which requires Visual Studio 2022, and supports latest GitLab CI with its preinstallation of Visual Studio 2022.
* ocaml/opam-repository tag moved to Jun 26, 2024.
* The patches to the OCaml compiler are now dual-licensed with OCaml's LGPL 2.1 exception and Apache 2.0. All other source (especially the build scripts) for the DkML compiler is solely Apache 2.0. This is a follow-up to <https://github.com/ocaml/ocaml/issues/13177>.
* The uninstaller stops `opam`, `dune` and other OCaml processes since, on Windows, in-use executables can't be deleted or updated.

### Minor Changes

* The appropriate `host-arch-x86_32/host-arch-x86_64` package is automatically added during `dkml init` on Windows. This makes DkML more consistent with opam 2.2.
* The `msys2-clang64` package is automatically added during `dkml init` on Windows. This makes DkML more consistent with opam 2.2.
* The `dkml init --system` command no longer adds the following Opam global variables. Instead, the presence of `host-arch-x86_32` (etc.) is used for opam filters in `conf-withdkml.2` and `conf-sqlite3.3.1+cpkgs`, which makes DkML more consistent with opam 2.2.

  | Global Variable        | Typical Value            |
  | ---------------------- | ------------------------ |
  | `msystem`              | `CLANG64`                |
  | `msystem-carch`        | `x86_64`                 |
  | `msystem-chost`        | `x86_64-w64-mingw32`     |
  | `msystem-prefix`       | `/clang64`               |
  | `mingw-chost`          | `x86_64-w64-mingw32`     |
  | `mingw-prefix`         | `/clang64`               |
  | `mingw-package-prefix` | `mingw-w64-clang-x86_64` |

### Upgraded Packages

| Package         | From                 | To         |
| --------------- | -------------------- | ---------- |
| opam            | 2.2.0-alpha-20221228 | 2.2.0      |
| sqlite3         | 5.1.0+msvc           | 5.2.0      |
| msys2           | 0.1.0                | 0.1.0+dkml |
| conf-pkg-config | 2+cpkgs              | 3+cpkgs    |

### Patches

| Package        | What                                      | Issue                                       |
| -------------- | ----------------------------------------- | ------------------------------------------- |
| `ocaml.4.14.2` | Backport: Linear-time closure computation | <https://github.com/ocaml/ocaml/pull/12222> |
