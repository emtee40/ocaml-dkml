## 2.1.2 (@@YYYYMMDD@@)

### First-time install of DkML

Before you run the installer: Make sure your Windows username does not contain a space character (e.g. for `C:\Users\Jane Smith`, OCaml will not install properly).

Run the following in a terminal (either Windows PowerShell or Command Prompt):

```powershell
winget install Microsoft.VisualStudio.2022.BuildTools --override "--wait --passive --installPath C:\VS17 --addProductLang En-us --add Microsoft.VisualStudio.Workload.VCTools --add Microsoft.VisualStudio.Component.VC.14.38.17.8.x86.x64 --includeRecommended"
winget install Git.Git
winget install Diskuv.OCaml
```

And then in a **NEW** terminal:

```powershell
dkml init --system
```

### Upgrading from version 2.1.0 or later

In PowerShell or Command Prompt:

```powershell
winget upgrade dkml
```

### Upgrading from versions earlier than 2.1.0

1. Download and run the "Windows/Intel 64-bit Native Uninstaller" from [DkML Releases 2.1.2](https://gitlab.com/dkml/distributions/dkml/-/releases/2.1.2).
2. Open **Add or remove programs** from Windows Search (type Windows key and then start typing "Add or remove programs")
   * Uninstall `Diskuv OCaml` and/or `DkML Native` and/or `DkML Bytecode` if you see them; you can ignore any failures. You can now close "Add or remove programs".
3. In PowerShell:

   ```powershell
   winget install dkml
   ```

### What do I do after the install is complete?

You SHOULD read the "Install is done! What next?" at <https://diskuv.com/dkmlbook/#install-is-done-what-next> documentation.

If you had any existing local switches, upgrade them by doing `dkml init`, `opam upgrade` and `opam install . --deps-only` in the local switch directories.

For projects using [`setup-dkml` (part of  `dkml-workflows`)](https://github.com/diskuv/dkml-workflows#dkml-workflows)
for their GitHub Actions / GitLab CI:

1. Re-run `dkml init`, `opam upgrade` and `opam install . --deps-only` in your project
2. Follow the THIRD step of <https://github.com/diskuv/dkml-workflows#configure-your-project>

### Major Changes

* Uses opam 2.2.0. You can directly use unmodified opam 2.2 with `opam-real switch create 5.2.0+msvc`. Or continue to use `dk Ml.Switch init` (or the deprecated `dkml init`) to create a DkML 4.14.2 switch which supports more native MSVC Windows packages (for now) but does not have the latest and experimental OCaml language features.
* Support Windows SDK 11 (10.0.22621.0) and VC 17.9 and 17.10 (14.39/4x) added to allowed list. This makes it easier to coexist with opam 2.2 which requires Visual Studio 2022, and supports latest GitLab CI with its preinstallation of Visual Studio 2022.
* The ocaml/opam-repository tag was advanced to Aug 15, 2024.
* You can continue to use `dkml.exe` and `with-dkml.exe` but both are deprecated; the new (unified) executable is `dk.exe`. See [Deprecated Commands](#deprecated-commands-in-212) in the release notes.
* Once every two weeks DkML news about new versions, errata, uninstalling, etc. will be shown on a webpage. It is triggered from the now deprecated `dkml init`, the replacement `dk Ml.Switch init` and the `with-dkml` proxy commands, and can be disabled with `dk Ml.News disable`. In particular, use `dk Ml.News` to show the news if you are experiencing problems with DkML.
* The patches to the OCaml compiler are now dual-licensed with OCaml's LGPL 2.1 exception and Apache 2.0. All other source (especially the build scripts) for the DkML compiler is licensed solely with Apache 2.0. This is a follow-up to <https://github.com/ocaml/ocaml/issues/13177>.
* The uninstaller stops `opam`, `dune` and other OCaml processes since, on Windows, in-use executables can't be deleted or updated.

### Deprecated Commands in 2.1.2

The deprecated commands still work, but will pause for 15 seconds after displaying the new command on the standard error.

| Old Command      | New Command     | Example              |
| ---------------- | --------------- | -------------------- |
| `dkml init`      | `dk Ml.Switch`  | `dk Ml.Switch init`  |
|                  | `dk Ml.News`    | `dk Ml.News show`    |
| `dkml version`   | `dk Ml.Version` | `dk Ml.Version show` |
| `with-dkml bash` | `dk Ml.Use`     | `dk Ml.Use -- bash`  |

### Minor Changes

* The appropriate `host-arch-x86_32/host-arch-x86_64` package is automatically added during `dkml init` on Windows. This makes DkML more consistent with opam 2.2.
* The appropriate `dkml-host-abi-windows_x86_64/windows_x86/...` package is automatically added during `dkml init`. The former `dkml-abi` switch variable is now called `dkml-host-abi`, and is set by the new `dkml-host-abi` package.
* Multiple target ABIs can be selected with, for example, `dkml-target-abi-darwin_arm64` when the host ABI is `dkml-host-abi-darwin_x86_64`.
* The `msys2-clang64` package is automatically added during `dkml init` on Windows. This makes DkML more consistent with opam 2.2.
* The Bytecode installer, which was deprecated, has now been removed from the distribution.
* The `dkml init --system` command no longer adds the following Opam global variables. Instead, the presence of `host-arch-x86_32` (etc.) is used for opam filters in `conf-withdkml.2` and `conf-sqlite3.3.1+cpkgs`, which makes DkML more consistent with opam 2.2.

  | Global Variable        | Typical Value            |
  | ---------------------- | ------------------------ |
  | `msystem`              | `CLANG64`                |
  | `msystem-carch`        | `x86_64`                 |
  | `msystem-chost`        | `x86_64-w64-mingw32`     |
  | `msystem-prefix`       | `/clang64`               |
  | `mingw-chost`          | `x86_64-w64-mingw32`     |
  | `mingw-prefix`         | `/clang64`               |
  | `mingw-package-prefix` | `mingw-w64-clang-x86_64` |

### Upgraded Packages

| Package             | From                 | To         |
| ------------------- | -------------------- | ---------- |
| opam                | 2.2.0-alpha-20221228 | 2.2.0      |
| sqlite3             | 5.1.0+msvc           | 5.2.0      |
| msys2               | 0.1.0                | 0.1.0+dkml |
| conf-pkg-config     | 2+cpkgs              | 3+cpkgs    |
| dkml-host-abi-* (1) |                      | 1          |

* `(1)` - `windows_x86_64` and the other DkML ABIs defined by dkml-c-probe

### Patches

| Package        | What                                      | Issue                                       |
| -------------- | ----------------------------------------- | ------------------------------------------- |
| `ocaml.4.14.2` | Backport: Linear-time closure computation | <https://github.com/ocaml/ocaml/pull/12222> |
